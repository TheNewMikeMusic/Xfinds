# 服务器更新指令 - HTTPS 和 8000 端口配置

## 一键更新命令

在服务器上执行以下命令，会自动从 GitHub 拉取最新代码并配置 HTTPS：

```bash
cat > /root/deploy-from-github.sh << 'SCRIPT_END'
#!/bin/bash
set -e

PROJECT_DIR="/var/www/xfinds"
GITHUB_TOKEN="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"
GITHUB_REPO_AUTH="https://${GITHUB_TOKEN}@github.com/TheNewMikeMusic/Xfinds.git"
BRANCH="main"
BACKUP_DIR="/var/www/xfinds-backup-$(date +%Y%m%d-%H%M%S)"

echo "=========================================="
echo "从 GitHub 拉取并部署 Xfinds（使用 Token 认证）"
echo "域名: xfinds.cc | 端口: 8000 | HTTPS: Let's Encrypt"
echo "=========================================="

echo ""
echo "=== 停止 PM2 进程 ==="
pm2 stop xfinds 2>/dev/null || true
pm2 delete xfinds 2>/dev/null || true

if [ -d "$PROJECT_DIR" ]; then
    echo ""
    echo "=== 备份现有项目 ==="
    mkdir -p "$BACKUP_DIR"
    if [ -f "$PROJECT_DIR/.env.local" ]; then
        cp "$PROJECT_DIR/.env.local" "$BACKUP_DIR/.env.local.backup"
        echo "已备份 .env.local"
    fi
    cp -r "$PROJECT_DIR" "$BACKUP_DIR/project" 2>/dev/null || true
    echo "备份完成"
fi

echo ""
echo "=== 清理现有项目 ==="
rm -rf "$PROJECT_DIR"
mkdir -p "$PROJECT_DIR"

echo ""
echo "=== 从 GitHub 拉取最新代码（使用 Token 认证） ==="
cd "$PROJECT_DIR"
git clone "$GITHUB_REPO_AUTH" .

echo ""
echo "=== 切换到 $BRANCH 分支 ==="
git checkout "$BRANCH"
git pull origin "$BRANCH"

if [ -f "$BACKUP_DIR/.env.local.backup" ]; then
    echo ""
    echo "=== 恢复环境变量配置 ==="
    cp "$BACKUP_DIR/.env.local.backup" "$PROJECT_DIR/.env.local"
    # 更新环境变量中的 URL 为 HTTPS
    sed -i 's|APP_URL=.*|APP_URL=https://xfinds.cc|' .env.local
    sed -i 's|NEXT_PUBLIC_APP_URL=.*|NEXT_PUBLIC_APP_URL=https://xfinds.cc|' .env.local
    echo "已恢复并更新 .env.local"
else
    echo ""
    echo "=== 创建新的环境变量配置 ==="
    JWT_SECRET=$(openssl rand -base64 32)
    cat > .env.local << EOF
NODE_ENV=production
JWT_SECRET=${JWT_SECRET}
AUTH_MODE=stub
APP_URL=https://xfinds.cc
NEXT_PUBLIC_APP_URL=https://xfinds.cc
EXCHANGE_RATE_API=https://api.exchangerate-api.com/v4/latest/CNY
EOF
    echo "已创建新的 .env.local"
fi

echo ""
echo "=== 安装依赖 ==="
npm install

echo ""
echo "=== 构建项目 ==="
npm run build

echo ""
echo "=== 启动应用（8000 端口） ==="
pm2 start npm --name "xfinds" -- start
pm2 save
pm2 startup | tail -1 | bash || true

echo ""
echo "=== 配置防火墙 ==="
ufw allow 8000/tcp 2>/dev/null || firewall-cmd --permanent --add-port=8000/tcp 2>/dev/null || true
ufw allow 80/tcp 2>/dev/null || firewall-cmd --permanent --add-port=80/tcp 2>/dev/null || true
ufw allow 443/tcp 2>/dev/null || firewall-cmd --permanent --add-port=443/tcp 2>/dev/null || true
firewall-cmd --reload 2>/dev/null || true

echo ""
echo "=== 配置 Nginx ==="
# 安装 Nginx（如果未安装）
if ! command -v nginx &> /dev/null; then
    echo "安装 Nginx..."
    apt-get update
    apt-get install -y nginx
fi

# 复制 Nginx 配置
cp nginx.conf /etc/nginx/sites-available/xfinds

# 启用站点
if [ ! -L /etc/nginx/sites-enabled/xfinds ]; then
    echo "启用 Nginx 站点..."
    ln -s /etc/nginx/sites-available/xfinds /etc/nginx/sites-enabled/
fi

# 测试并重新加载 Nginx
echo "测试 Nginx 配置..."
nginx -t && systemctl reload nginx || echo "Nginx 配置测试失败，请检查配置"

echo ""
echo "=== 配置 HTTPS（Let's Encrypt） ==="
echo "检查是否已配置 SSL 证书..."

if [ ! -f /etc/letsencrypt/live/xfinds.cc/fullchain.pem ]; then
    echo "SSL 证书不存在，开始配置..."
    chmod +x setup-https.sh
    
    # 修改 setup-https.sh 中的邮箱（可选）
    # sed -i 's|EMAIL="admin@xfinds.cc"|EMAIL="your-email@example.com"|' setup-https.sh
    
    echo "执行 HTTPS 配置脚本..."
    echo "注意：需要确保域名 xfinds.cc 已正确解析到服务器 IP"
    ./setup-https.sh
else
    echo "SSL 证书已存在，跳过证书获取"
    echo "如需更新证书，请运行: certbot renew"
fi

echo ""
echo "=========================================="
echo "部署完成！"
echo "访问地址: https://xfinds.cc"
echo "备份位置: $BACKUP_DIR"
echo "=========================================="
pm2 status

echo ""
echo "验证步骤："
echo "1. 检查 PM2 状态: pm2 status"
echo "2. 检查 Nginx 状态: systemctl status nginx"
echo "3. 访问 https://xfinds.cc"
echo "4. 检查 SSL 证书: certbot certificates"
SCRIPT_END

chmod +x /root/deploy-from-github.sh
/root/deploy-from-github.sh
```

## 分步执行（如果一键命令失败）

### 步骤 1: 连接到服务器
```bash
ssh root@154.21.200.177
```

### 步骤 2: 执行部署脚本
```bash
/root/deploy-from-github.sh
```

### 步骤 3: 如果 HTTPS 未自动配置，手动执行
```bash
cd /var/www/xfinds
chmod +x setup-https.sh
./setup-https.sh
```

## 验证部署

部署完成后，执行以下命令验证：

```bash
# 检查 PM2 状态
pm2 status

# 检查应用日志
pm2 logs xfinds

# 检查 Nginx 状态
systemctl status nginx

# 检查 SSL 证书
certbot certificates

# 测试 HTTPS
curl -I https://xfinds.cc
```

## 故障排查

### 如果应用无法启动
```bash
pm2 logs xfinds
cd /var/www/xfinds
npm run build
```

### 如果 Nginx 配置失败
```bash
nginx -t
cat /etc/nginx/sites-available/xfinds
```

### 如果 HTTPS 证书获取失败
1. 确保域名 `xfinds.cc` 已正确解析到服务器 IP
2. 确保 80 端口已开放
3. 手动执行：`certbot --nginx -d xfinds.cc -d www.xfinds.cc`

### 如果端口冲突
```bash
# 检查端口占用
netstat -tulpn | grep 8000
# 或
lsof -i :8000
```

## 重要提示

- 确保域名 `xfinds.cc` 的 DNS 记录已正确配置
- 首次部署 HTTPS 需要域名已解析，否则证书获取会失败
- 证书会自动续期，无需手动操作
- 应用运行在 8000 端口，通过 Nginx 反向代理和 HTTPS 访问

