# 修复 502 Bad Gateway 错误

## 问题描述

502 Bad Gateway 错误表示 Nginx 无法连接到后端 Next.js 应用。

## 快速诊断和修复

### 步骤 1: 检查应用状态

```bash
# 检查 PM2 进程状态
pm2 status

# 检查应用日志
pm2 logs xfinds --lines 50

# 检查端口 8000 是否在监听
netstat -tulpn | grep 8000
# 或
ss -tulpn | grep 8000
```

### 步骤 2: 检查应用是否正常运行

```bash
# 直接测试本地端口
curl http://localhost:8000

# 如果返回错误，说明应用没有运行
```

### 步骤 3: 重启应用

```bash
cd /var/www/xfinds

# 停止应用
pm2 stop xfinds

# 检查是否有构建文件
ls -la .next

# 如果没有 .next 目录或构建失败，重新构建
npm run build

# 重启应用
pm2 restart xfinds

# 等待几秒后检查状态
sleep 3
pm2 status
pm2 logs xfinds --lines 20
```

### 步骤 4: 检查 Nginx 配置

```bash
# 测试 Nginx 配置
nginx -t

# 检查 Nginx 错误日志
tail -50 /var/log/nginx/xfinds-error.log

# 重新加载 Nginx
systemctl reload nginx
```

### 步骤 5: 完整重启流程（如果上述步骤无效）

```bash
cd /var/www/xfinds

# 停止所有进程
pm2 stop xfinds
pm2 delete xfinds

# 清理缓存
rm -rf .next
rm -rf node_modules/.cache

# 重新构建
npm run build

# 重新启动
pm2 start npm --name "xfinds" -- start
pm2 save

# 检查状态
pm2 status
pm2 logs xfinds --lines 30
```

## 常见原因和解决方案

### 原因 1: 应用未运行或已崩溃

**症状**: `pm2 status` 显示应用为 `stopped` 或 `errored`

**解决**:
```bash
pm2 restart xfinds
# 或
pm2 delete xfinds
pm2 start npm --name "xfinds" -- start
```

### 原因 2: 构建文件缺失或损坏

**症状**: `.next` 目录不存在或 `pm2 logs` 显示构建错误

**解决**:
```bash
cd /var/www/xfinds
rm -rf .next
npm run build
pm2 restart xfinds
```

### 原因 3: 端口被占用

**症状**: `netstat -tulpn | grep 8000` 显示端口被其他进程占用

**解决**:
```bash
# 查找占用端口的进程
lsof -i :8000
# 或
fuser -k 8000/tcp

# 然后重启应用
pm2 restart xfinds
```

### 原因 4: Nginx 配置错误

**症状**: `nginx -t` 显示配置错误

**解决**:
```bash
# 检查配置文件
cat /etc/nginx/sites-available/xfinds | grep proxy_pass

# 确保 proxy_pass 指向正确的端口
# 应该是: proxy_pass http://localhost:8000;

# 如果配置正确，重新加载
nginx -t && systemctl reload nginx
```

### 原因 5: 防火墙阻止连接

**症状**: 应用运行正常，但 Nginx 无法连接

**解决**:
```bash
# 检查防火墙规则
ufw status
# 或
firewall-cmd --list-all

# 确保 8000 端口开放（本地连接不需要，但检查一下）
# Nginx 和 Next.js 在同一服务器，不需要防火墙规则
```

## 一键修复脚本

如果上述步骤都无效，执行完整修复：

```bash
cd /var/www/xfinds

# 停止并删除 PM2 进程
pm2 stop xfinds 2>/dev/null || true
pm2 delete xfinds 2>/dev/null || true

# 清理缓存
rm -rf .next
rm -rf node_modules/.cache

# 重新构建
npm run build

# 重新启动
pm2 start npm --name "xfinds" -- start
pm2 save

# 等待启动
sleep 5

# 检查状态
pm2 status
pm2 logs xfinds --lines 30

# 测试本地连接
curl -I http://localhost:8000

# 重新加载 Nginx
nginx -t && systemctl reload nginx

echo "修复完成！请检查 pm2 status 和 pm2 logs"
```

## 验证修复

修复后，执行以下命令验证：

```bash
# 1. 检查 PM2 状态（应该是 online）
pm2 status

# 2. 检查端口监听
netstat -tulpn | grep 8000

# 3. 测试本地连接
curl -I http://localhost:8000

# 4. 测试 HTTPS 访问
curl -I https://xfinds.cc

# 5. 检查 Nginx 错误日志
tail -20 /var/log/nginx/xfinds-error.log
```

如果所有检查都通过，502 错误应该已解决。

